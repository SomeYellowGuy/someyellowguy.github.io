<html>
<script>
var load = new Date();
var timetakehelp = 0;
var getParameters = function(name, defaultValue) { // Taken from Blockly code.js
  var val = location.search.match(new RegExp('[?&]' + name + '=([^&]+)'));
  return val ? decodeURIComponent(val[1].replace(/\+/g, '%20')) : defaultValue;
};
var levelmax = [9,17,12,"5","7","7","10"];
isMobile = (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));
/**
   Number - Is not a limited block level
   String - Is a limited block level
*/
var getBlocksNumber = function(){
  if (typeof workspace === "undefined") return 0;
  return workspaceMax - workspace.remainingCapacity();
}
var setHint = function(func,a,b){
    try {
       document.getElementById('help').addEventListener("click",function(){
	      func(a,b);
	   })
	   console.log("Successfully set an event listener! (Take "+(++timetakehelp)+")")
	} catch(e) {
	   if (!(timetakehelp > 48)) {
	     console.warn("Tried to set an event listener but didn't work. (Take "+(++timetakehelp)+")")
	     setTimeout(function(){setHint(func,a,b)},1000)
	   } else {
	     console.error("Given up setting an event listener because we took "+(++timetakehelp)+" takes (maximum).")
	   }
	}
}
var levelno = getParameters("level","1")
var isHard = typeof levelmax[Number(levelno)-1] === "string";
var workspaceMax = isHard ? Number(levelmax[levelno-1]) : 1e+10;
var mes_maxblock, mes_maxblocks_color;
setInterval(function(){
      mes_maxblock = "Blocks m"+(isHard?"aximum":"inimum")+": "+getBlocksNumber()+"/"+Number(levelmax[Number(levelno)-1]);
	  var x = levelmax[Number(levelno)-1]
	  var __gold = !isHard ? "#fcc603" : "green"
	  var __sliver = !isHard ? "#bfbfbf" : "red"
	  var __bronze = !isHard ? "#c77e00" : "red"
	  y = function(){
	  if (x+1 > getBlocksNumber()) return __gold // gold (minimum)
	  if (x+3 > getBlocksNumber()) return __sliver // sliver (3+)
	  if (x+7 > getBlocksNumber()) return __bronze // bronze (7+)
	  return isHard?"red":"green"; // green (more..)
	  };
	  mes_maxblocks_color = y();
},50)
var empty = getParameters("level",false);
if (!empty) window.location.href = "?level=1"
</script>
   <body>
      <head>
	    <style>
		   @font-face {
              font-family: 'Segoe UI';
              src: url('segoeui.woff') format('woff');
              font-weight: normal;
              font-style: normal;
           }
		   .blocklytreelabel, .blocklytext, .goog-menuitem-content, .blocklytooltip, .blocklyflyoutlabeltext, p {
		      font-family: Segoe UI !important;
		   }
		   #DialogBackdrop {
		     position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,.7); z-index: 100; height: 650;
		   }
		   #Dialog {
		     background-color: #85deff; width: 400px; margin: 20px auto 0; padding: 10px;
		   }
		   #Dialog_hard {
		     background-color: #d085ff; width: 400px; margin: 20px auto 0; padding: 10px;
		   }
		   .DialogTitle {
		      font-family: Segoe UI;
			  font-weight: bold;
		   }
		   .DialogTitle_hard {
		      font-family: Segoe UI;
			  font-weight: bold;
			  color: white;
		   }
		   .DialogMessage {
		      font-family: Segoe UI;
		   }
		   .DialogMessage_hard {
		      font-family: Segoe UI;
			  color: white;
		   }
		   #dialogInput {
		      background-color: #b5ebff;
			  font-family: Segoe UI;
			  border: 2px solid #0781ad;
		   }
		   #DialogCancel {
		     background-color: #63bfe0;
             text-align: center;
			 font-size: 12px;
			 padding: 5px 9px;
			 border-radius: 8px;
			 border: 2px solid #0781ad;
			 color: white;
			 font-family: Segoe UI;
		   }
		   #DialogOkay {
		   	 background-color: #63bfe0;
             text-align: center;
			 font-size: 12px;
			 padding: 5px 9px;
			 border-radius: 8px;
			 border: 2px solid #0781ad;
			 color: white;
			 font-family: Segoe UI;
		   }
		   #DialogCancel_hard {
		     background-color: #ac63e0;
             text-align: center;
			 font-size: 12px;
			 padding: 5px 9px;
			 border-radius: 8px;
			 border: 2px solid #7007ad;
			 color: white;
			 font-family: Segoe UI;
		   }
		   #DialogOkay_hard {
		   	 background-color: #ac63e0;
             text-align: center;
			 font-size: 12px;
			 padding: 5px 9px;
			 border-radius: 8px;
			 border: 2px solid #7007ad;
			 color: white;
			 font-family: Segoe UI;
		   }
		   a {
		     color: #85deff;
		   }
		   a_hard {
		     color: #d085ff;
		   }
		   #run {
		     background-color: #ffa82e;
			 color: white;
			 text-align: center
			 font-size: 24px;
			 font-family: Segoe UI;
			 padding: 13px 55px;
			 border-radius: 2px;
			 border: 1px solid #fc9e19;
		   }
		   #run {
               transition-duration: 0.3s;
           }
           #run:hover {
              background-color: white;
              color: #ffa82e;
           }
		   #run:disabled:hover {
              background-color: #440000;
           }
		   #seecode {
		     background-color: #0073ff;
			 color: white;
			 text-align: center
			 font-size: 29px;
			 font-family: Segoe UI;
			 padding: 13px 55px;
			 border-radius: 2px;
			 border: 1px solid #1ca0ff;
		   }
		   #seecode {
               transition-duration: 0.3s;
           }
           #seecode:hover {
              background-color: white;
              color: #0073ff;
           }
		   div {
		      font-family: Segoe UI; !important
		   }
		   .DialogCode {
		      background-color: #a6e3ff;
		   }
		   .DialogCode_hard {
		      background-color: #dda6ff;
			  color: white;
		   }
		   #levelselect {
		      background-color: #f44336;
			  font-size: 20px;
			  padding: 14px 40px;
			  border-radius: 3px;
			  color: white;
			  border: 2px solid #f44336;
			  transition-duration: 0.2s;
		   }
		   #levelselect:hover {
		      background-color: white;
              color: #f44336;
		   }
		   button:disabled {
              opacity: 0.6;
              cursor: not-allowed;
           }
		   fonted {
		      font-family: Segoe UI; !important
		   }
		   #speed {
		      -webkit-appearance: none;
			  width: 20%;
			  height: 15px;
              appearance: none;
			  border-radius: 10px; 
		      outline: none;
		      background: #666666;
		   }
		   #speed::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 25px;
                height: 25px;
                border-radius: 50%; 
                background: #444444;
                cursor: pointer;
           }
		   #speed::-moz-range-thumb {
             width: 25px;
             height: 25px;
             border-radius: 50%;
             background: #444444;
             cursor: pointer;
           }
		   #help {
		     background: #00ff00;
			 width: 150px;
             height: 50px;
			 font-family: Segoe UI;
			 font-size: 18px;
			 border-radius: 5px;
			 border: 2px solid #009900;
             transition-duration: 0.3s;
           }
           #help:hover {
              background-color: #99ff99;
              color: #005500;
           }
		   #stop {
		     background: #7700ff;
			 width: 150px;
             height: 50px;
			 font-family: Segoe UI;
			 font-size: 18px;
			 border-radius: 5px;
			 border: 2px solid #330077;
             transition-duration: 0.3s;
			 color: white;
           }
		   #stop:hover {
              background-color: #ff77aa;
           }
		   #stop:disabled:hover {
              background-color: #ffaacc;
			  color: #000;
           }
		</style>
	    <script src="blockly_compressed.js"></script>
		<script src="acorn_interpreter.js"></script>
		<script src="javascript_compressed.js"></script>
		<script src="comment.js"></script>
		<script src="alert.js"></script>
		<canvas id="a" height="450" width="480"></canvas>
		<div id="blocklyDiv" style="height: 440px; width: 700px; float: right;"></div>
	  </head>
	  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox1" style="display: none">
       <category name="Move" colour="#5ba55b">
         <block type="move_forward"></block>
		 <block type="move" disabled="true">
		     <field name="way">forward</field>
		 </block>
		 <label text="Unlocked in level 2!"></label>
       </category>
     </xml>
	 <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox2" style="display: none">
  <category name="Move" colour="#5ba55b">
    <block type="move">
      <field name="way">forward</field>
    </block>
	<sep></sep>
    <block type="move_rotate">
      <field name="direction">left</field>
    </block>
	<block type="move_rotate">
      <field name="direction">right</field>
    </block>
  </category>
  <category name="Loops" colour="#9539f7">
    <block type="controls_repeat_limited" disabled="true">
	  <field name="count">2</field>
	</block>
	<label text="Unlocked in level 3!"></label>
  </category>
    </xml>
	 <xml xmlns="https://developers.google.com/blockly/xml" id="workspaceBlocks" style="display: none">
  <block type="run" id="N6C,wtM,3lVn:UXCk)hC" x="150" y="13" deletable="false" disabled="false" movable="false"></block>
     </xml>
	 <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox3" style="display: none">
	 <category name="Move" colour="#5ba55b">
    <block type="move">
      <field name="way">forward</field>
    </block>
	<sep></sep>
    <block type="move_rotate">
      <field name="direction">left</field>
    </block>
	<block type="move_rotate">
      <field name="direction">right</field>
    </block>
  </category>
  <category name="Loops" colour="#9539f7">
    <block type="controls_repeat_limited"></block>
	<block type="loops_until_finish" disabled="true"></block>
	<label text="Unlocked in level 4!"></label>
  </category>
  <category name="Logic" colour="195">
      <block type="logic_has_space" disabled="true"></block>
	  <label text="Unlocked in level 4!"></label>
	  <block type="logic_has_space_with_else" disabled="true"></block>
	  <label text="Unlocked in level 5!"></label>
  </category>
     </xml>
	 	 <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox4" style="display: none">
	 <category name="Move" colour="#5ba55b">
    <block type="move">
      <field name="way">forward</field>
    </block>
	<sep></sep>
    <block type="move_rotate">
      <field name="direction">left</field>
    </block>
	<block type="move_rotate">
      <field name="direction">right</field>
    </block>
  </category>
  <category name="Loops" colour="#9539f7">
    <block type="controls_repeat_limited"></block>
	<block type="loops_until_finish"></block>
	<block type="loops_while_space" disabled="true"></block>
	<label text="Unlocked in level 6!"></label>
  </category>
  <category name="Logic" colour="195">
      <block type="logic_has_space"></block>
	  <block type="logic_has_space_with_else" disabled="true"></block>
	  <label text="Unlocked in level 5!"></label>
  </category>
     </xml>
	 	 <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox5" style="display: none">
	 <category name="Move" colour="#5ba55b">
    <block type="move">
      <field name="way">forward</field>
    </block>
	<sep></sep>
    <block type="move_rotate">
      <field name="direction">left</field>
    </block>
	<block type="move_rotate">
      <field name="direction">right</field>
    </block>
  </category>
  <category name="Loops" colour="#9539f7">
    <block type="controls_repeat_limited"></block>
	<block type="loops_until_finish"></block>
	<block type="loops_while_space" disabled="true"></block>
	<label text="Unlocked in level 6!"></label>
  </category>
  <category name="Logic" colour="195">
      <block type="logic_has_space"></block>
	  <block type="logic_has_space_with_else"></block>
  </category>
     </xml>
	<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox6" style="display: none">
	 <category name="Move" colour="#5ba55b">
    <block type="move">
      <field name="way">forward</field>
    </block>
	<sep></sep>
    <block type="move_rotate">
      <field name="direction">left</field>
    </block>
	<block type="move_rotate">
      <field name="direction">right</field>
    </block>
  </category>
  <category name="Loops" colour="#9539f7">
    <block type="controls_repeat_limited"></block>
	<block type="loops_until_finish"></block>
	<block type="loops_while_space"></block>
	<block type="loops_until_space" disabled="true"></block>
	<label text="Unlocked in level 7"></label>
  </category>
  <category name="Logic" colour="195">
      <block type="logic_has_space"></block>
	  <block type="logic_has_space_with_else"></block>
  </category>
     </xml>
	 	<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox7" style="display: none">
	 <category name="Move" colour="#5ba55b">
    <block type="move">
      <field name="way">forward</field>
    </block>
	<sep></sep>
    <block type="move_rotate">
      <field name="direction">left</field>
    </block>
	<block type="move_rotate">
      <field name="direction">right</field>
    </block>
  </category>
  <category name="Loops" colour="#9539f7">
    <block type="controls_repeat_limited"></block>
	<block type="loops_until_finish"></block>
	<sep></sep>
	<block type="loops_while_space" disabled="true"></block>
	<label text="Cannot be used in level 7."></label>
	<sep></sep>
	<block type="loops_until_space"></block>
  </category>
  <category name="Logic" colour="195">
      <block type="logic_has_space"></block>
	  <block type="logic_has_space_with_else"></block>
  </category>
     </xml>
      <script>
	        Blockly.defineBlocksWithJsonArray([{
  "type": "move",
  "message0": "move %1",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "way",
      "options": [
        [
          "forward",
          "forward"
        ],
        [
          "backward",
          "backward"
        ]
      ]
    }
  ],
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": 105,
  "tooltip": "Makes the cube move forward or backward once.",
  "helpUrl": ""
},
{
  "type": "run",
  "message0": "when run %1 %2",
  "args0": [
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "run"
    }
  ],
  "inputsInline": true,
  "colour": "#ff9f00",
  "tooltip": "",
  "helpUrl": ""
},{
  "type": "move_forward",
  "message0": "move forward",
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": 105,
  "tooltip": "Makes the cube move forward or backward once.",
  "helpUrl": ""
},{
  "type": "move_rotate",
  "message0": "turn %1 90\u00b0",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "direction",
      "options": [
        [
          "left \u21ba",
          "left"
        ],
        [
          "right \u21bb",
          "right"
        ]
      ]
    }
  ],
  "inputsInline": true,
  "previousStatement": null,
  "nextStatement": null,
  "colour": 150,
  "tooltip": "Rotate the cube's direction by 90\u00b0.",
  "helpUrl": ""
},{
  "type": "controls_repeat_limited",
  "message0": "repeat %1 times %2 %3",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "count",
      "options": [
        [
          "2",
          "2"
        ],
        [
          "3",
          "3"
        ],
        [
          "4",
          "4"
        ],
        [
          "5",
          "5"
        ],
        [
          "6",
          "6"
        ],
        [
          "7",
          "7"
        ],
        [
          "8",
          "8"
        ],
        [
          "9",
          "9"
        ],[
          "10",
          "10"
        ]
      ]
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "command"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#9539f7",
  "tooltip": "Execute code a set number of times.",
  "helpUrl": ""
}]);
Blockly.defineBlocksWithJsonArray([{
  "type": "logic_has_space",
  "message0": "if path %1 exists %2 do %3",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "NAME",
      "options": [
        [
          "ahead \u2191",
          "ahead"
        ],
        [
          "to the left \u2190",
          "left"
        ],
        [
          "to the right \u2192",
          "right"
        ]
      ]
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "script"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": 195,
  "tooltip": "Check if a path exists and if it does, execute code.",
  "helpUrl": ""
},
{
  "type": "logic_has_space_with_else",
  "message0": "if path %1 exists %2 do %3 else %4",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "NAME",
      "options": [
        [
          "ahead \u2191",
          "ahead"
        ],
        [
          "to the left \u2190",
          "left"
        ],
        [
          "to the right \u2192",
          "right"
        ]
      ]
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "script"
    },
    {
      "type": "input_statement",
      "name": "script2"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": 195,
  "tooltip": "Check if a path exists and if it does, execute code in the if statement, otherwise execute the code in the else statement.",
  "helpUrl": ""
},{
  "type": "logic_has_side_with_else",
  "message0": "if path %1 exists %2 do %3 else %4",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "NAME",
      "options": [
        [
          "to the left \u2190",
          "left"
        ],
        [
          "to the right \u2192",
          "right"
        ]
      ]
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "script"
    },
    {
      "type": "input_statement",
      "name": "script2"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": 195,
  "tooltip": "Check if a path exists and if it does, execute code in the if statement, otherwise execute the code in the else statement. Doesn't include path ahead.",
  "helpUrl": ""
},{
  "type": "loops_while_space",
  "message0": "while path %1 exists %2 do %3",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "value",
      "options": [
        [
          "ahead",
          "ahead"
        ],
        [
          "to the left",
          "left"
        ],
        [
          "to the right",
          "right"
        ]
      ]
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "script"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#9539f7", // Agastya suggestion: can you make it magenta?
  "tooltip": "Repeat code inside the statement until a path doesn't exist.",
  "helpUrl": ""
},{
  "type": "loops_until_finish",
  "message0": "repeat until %1 %2 do %3",
  "args0": [
    {
      "type": "field_image",
      "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAMSURBVBhXY7D3OAMAAh0BVEDFEogAAAAASUVORK5CYII=",
      "width": 15,
      "height": 15,
      "alt": "*",
      "flipRtl": false
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "script"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "colour": "#9539f7",
  "tooltip": "Repeat code inside the statement until the player reaches the blue space.",
  "helpUrl": ""
},{
  "type": "loops_until_space",
  "message0": "repeat until path %1 exists %2 do %3",
  "args0": [
    {
      "type": "field_dropdown",
      "name": "value",
      "options": [
        [
          "ahead",
          "ahead"
        ],
        [
          "to the left",
          "left"
        ],
        [
          "to the right",
          "right"
        ]
      ]
    },
    {
      "type": "input_dummy"
    },
    {
      "type": "input_statement",
      "name": "script"
    }
  ],
  "inputsInline": false,
  "previousStatement": null,
  "nextStatement": null,
  "colour": "#9539f7",
  "tooltip": "Repeat code inside the statement until a path exists.",
  "helpUrl": ""
}]);

if (isMobile) {
    document.getElementById("blocklyDiv").style = "height: 450px; width: 440px; float: right;";
}

var toolbox = document.getElementById("toolbox"+levelno);

var options = { 
	toolbox : toolbox, 
	collapse : true, 
	comments : true, 
	disable : true, 
	maxBlocks : workspaceMax, 
	trashcan : true, 
	horizontalLayout : false, 
	toolboxPosition : 'start', 
	css : true, 
	media : 'https://blockly-demo.appspot.com/static/media/', 
	rtl : false, 
	scrollbars : true, 
	sounds : true, 
	oneBasedIndex : true
};


var workspace = Blockly.inject("blocklyDiv", options);

var workspaceBlocks = document.getElementById("workspaceBlocks"); 

Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);

var canvas = document.getElementById("a").getContext("2d");
var can = document.getElementById("a");
function component(width, height, color, x, y) {
  this.width = width;
  this.height = height;
  this.x = x;
  this.y = y;
  this.c = color;
  ctx = canvas;
  ctx.fillStyle = color;
  ctx.fillRect(this.x, this.y, this.width, this.height);
  this.update = function(){
    ctx = canvas;
    ctx.fillStyle = color;
    ctx.fillRect(this.x, this.y, this.width, this.height);
  }
}
var dir = [1,0];
var paths = [];
var c = {};
c.g1 = "#00ff00";
c.g2 = "#00dd00";
c.b1 = "#0000ee";
c.b2 = "#0000cc";
c.s1 = "#000000";
c.s2 = "#444444";
c.t1 = "#aaffaa";
c.t2 = "#666666";
switch(levelno){
  case "1":
     // W, H, color, X, Y
	 for (var i=-1; i<12; i++){
      paths[i+8] = new component(40,40,eval("c.s"+(i%2+1)),40*i-40,80);
	 }
	 for (var i=-1; i<12; i++){
      paths[i+21] = new component(40,40,eval("c.s"+(i%2+1)),40*i-40,0);
	 }
	 for (var i=0; i<8; i++){
      paths[i] = new component(40,40,eval("c.g"+(i%2+1)),40*i+40,40);
	 }
	 paths[33] = new component(40,40,c.s1,400,40);
	 paths[34] = new component(40,40,c.s1,0,40);
	 paths[8] = new component(40,40,c.b1,360,40);
     var player = new component(40, 40, "red",40, 40);
	 var directionplayer = new component(10,10,"#ff8888",40,40)
	 Blockly.goal('Make the red cube go to the blue square.',function(){
	    Blockly.how('Move forward: This block makes the cube move to its direction. Click on the Move category to get the block.')
	 },1)
	 break;
  case "2":
	 for (var i=0; i<12; i++){
      paths[i] = new component(40,40,eval("c.s"+(i%2+1)),40*i,80);
	 }
	 paths[12] = new component(40,40,c.s2,0,120)
	 for (var i=0; i<10; i++){
      paths[i+13] = new component(40,40,eval("c.s"+(i%2+1)),40*i,160);
	 }
	 for (var i=0; i<10; i++){
      paths[i+23] = new component(40,40,eval("c.g"+(i%2+1)),40*i+40,120);
	 }
	 for (var i=2; i<9; i++){
      paths[i+31] = new component(40,40,eval("c.g"+((i+1)%2+1)),400,40*i+40);
	 }
	 for (var i=1; i<10; i++){
      paths[i+39] = new component(40,40,eval("c.s"+(i%2+1)),440,40*i+40);
	 }
	 for (var i=1; i<7; i++){
      paths[i+48] = new component(40,40,eval("c.s"+((i+1)%2+1)),360,40*i+160);
	 }
	 paths[55] = new component(40,40,c.s1,400,400);
	 var player = new component(40, 40, "red",40, 120);
	 var directionplayer = new component(10,10,"#ff8888",40,120)
	 paths[56] = new component(40,40,c.b1,400,360);
	 
	 Blockly.goal("The player can now turn left or right, but help him reach the blue space!",function(){
	    Blockly.how('Turn (left/right) 90\u00b0: Rotates the cube\'s direction by 90\u00b0 in the specified direction.');
	 },2)
	 break;
  case "3":
  // Black and grey part.
     for (var i=0; i<7; i++){
      paths[i] = new component(40,40,eval("c.s"+(i%2+1)),40*i,40);
	 }
	  paths[7] = new component(40,40,c.s2,0,80);
	 for (var i=0; i<6; i++){
      paths[i+8] = new component(40,40,eval("c.s"+(i%2+1)),40*i,120);
	 }
	 for (var i=0; i<7; i++){
      paths[i+14] = new component(40,40,eval("c.s"+(i%2+1)),200,40*i+160);
	 }
	 for (var i=0; i<4; i++){
      paths[i+21] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+240,400);
	 }
	 for (var i=0; i<10; i++){
      paths[i+25] = new component(40,40,eval("c.s"+((i+1)%2+1)),360,40*i+40);
	 }
	 for (var i=0; i<2; i++){
      paths[i+35] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+280,40);
	 }
	 for (var i=0; i<7; i++){
      paths[i+37] = new component(40,40,eval("c.s"+(i%2+1)),280,40*i+80);
	 }
	 // Green part.
	 for (var i=1; i<6; i++){
      paths[i+43] = new component(40,40,eval("c.g"+(i%2+1)),40*i,80);
	 }
	 for (var i=0; i<8; i++){
      paths[i+49] = new component(40,40,eval("c.g"+(i%2+1)),240,40*i+80);
	 }
	 for (var i=0; i<7; i++){
      paths[i+57] = new component(40,40,eval("c.g"+((i+1)%2+1)),320,40*i+120);
	 }
	 paths[64] = new component(40,40,c.g1,280,360);
	 // Finish (blue spot).
	 paths[65] = new component(40,40,c.b1,320,80);
	 // Player (red square).
	 var player = new component(40, 40, "red",40, 80);
	 var directionplayer = new component(10,10,"#ff8888",40,80)
	 Blockly.goal("There is now a 'repeat' block to make it easier! Can you help the player to get to the blue space?",function(){
	    Blockly.how("Repeat block: Repeats the script inside by the specified number.")
	 },3);
	 break;
  case "4":
     //Message
	 Blockly.goal("You now have if path blocks to shorten your code, but that is exactly what that is! You have a 5 block limit, so try to use the most minimum blocks possible! The goal is the same: Help the player to reach the blue space. Use the repeat until block to complete it!",function(){
	    Blockly.how('If path blocks: Checks if a path given exists (depends on the player\'s direction), if it is true, runs the script inside.',function(){
		   Blockly.how('Repeat until [finish]: Keeps repeating the script inside until the player reaches the finish.')
		},4)
	 },4);
	 // Black and grey part.
	 for (var i=0; i<11; i++){
      paths[i] = new component(40,40,eval("c.s"+(i%2+1)),40*i,400);
	 }
	 for (var i=0; i<10; i++){
      paths[i+11] = new component(40,40,eval("c.s"+(i%2+1)),400,40*i);
	 }
	 for (var i=0; i<11; i++){
      paths[i+21] = new component(40,40,eval("c.s"+(i%2+1)),40*i,0);
	 }
	 for (var i=0; i<9; i++){
      paths[i+32] = new component(40,40,eval("c.s"+(i%2+1)),0,40*i);
	 }
	 for (var i=0; i<8; i++){
      paths[i+41] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+40,320);
	 }
	 for (var i=0; i<6; i++){
      paths[i+49] = new component(40,40,eval("c.s"+(i%2+1)),320,40*i+80);
	 }
	 for (var i=0; i<6; i++){
      paths[i+55] = new component(40,40,eval("c.s"+(i%2+1)),40*i+80,80);
	 }
	 for (var i=0; i<4; i++){
      paths[i+61] = new component(40,40,eval("c.s"+((i+1)%2+1)),80,40*i+120);
	 }
	 for (var i=0; i<5; i++){
      paths[i+65] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+120,240);
	 }
	 for (var i=0; i<5; i++){
      paths[i+70] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+120,160);
	 }
	 for (var i=0; i<5; i++){
      paths[i+75] = new component(40,40,eval("c.s"+(i%2+1)),40*i+120,120);
	 }
	 for (var i=0; i<5; i++){
      paths[i+80] = new component(40,40,eval("c.s"+(i%2+1)),40*i+120,200);
	 }
	 for (var i=0; i<5; i++){
	  for (var j=0; j<3; j++) {
	   paths[(i*3)+j+85] = new component(40,40,eval("c.t"+((((i*3)+j)%2+1))),40*i+120,120+j*40);
	  }
	 }
	 // Green part.
	 var player = new component(40, 40, "red",0, 360);
	 var directionplayer = new component(10,10,"#ff8888",0,360)
	 for (var i=0; i<10; i++){
       paths[i+100] = new component(40,40,eval("c.g"+(i%2+1)),40*i,360);
	 }
	 for (var i=0; i<8; i++){
      paths[i+110] = new component(40,40,eval("c.g"+(i%2+1)),360,40*i+80);
	 }
	 for (var i=0; i<9; i++){
       paths[i+118] = new component(40,40,eval("c.g"+((i+1)%2+1)),40*i+40,40);
	 }
	 for (var i=0; i<6; i++){
      paths[i+127] = new component(40,40,eval("c.g"+(i%2+1)),40,40*i+80);
	 }
	 for (var i=0; i<5; i++){
       paths[i+133] = new component(40,40,eval("c.g"+(i%2+1)),40*i+80,280);
	 }
	 paths[138] = new component(40,40,eval("c.b2"),40*i+80,280);
	 break;
  case "5":
     dir = [0,-1];
	 Blockly.goal("You now have if path else blocks! Try using one to complete the level!",function(){
	    Blockly.how('If path else blocks: Checks if a path given exists (depends on the player\'s direction), if it is true, runs the script on the top, else runs the script on the bottom.')},4);
	 var player = new component(40, 40, "red",40, 40);
	 var directionplayer = new component(10,10,"#ff8888",40,40)
	 // Black and grey part.
	 // Exterior
	 for (var i=0; i<3; i++){
      paths[i] = new component(40,40,eval("c.s"+(i%2+1)),40*i,0);
	 }
	 for (var i=0; i<6; i++){
      paths[i+3] = new component(40,40,eval("c.s"+((i+1)%2+1)),0,40*i+40);
	 }
	 for (var i=0; i<4; i++){
      paths[i+9] = new component(40,40,eval("c.s"+((i+1)%2+1)),80,40*i+40);
	 }
	 for (var i=0; i<4; i++){
      paths[i+13] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+40,240);
	 }
	 for (var i=0; i<2; i++){
      paths[i+17] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+120,80);
	 }
	 for (var i=0; i<2; i++){
      paths[i+19] = new component(40,40,eval("c.s"+(i%2+1)),160,40*i);
	 }
	 for (var i=0; i<6; i++){
      paths[i+21] = new component(40,40,eval("c.s"+(i%2+1)),40*i+160,0);
	 }
	 for (var i=0; i<8; i++){
      paths[i+27] = new component(40,40,eval("c.s"+(i%2+1)),400,40*i);
	 }
	 for (var i=0; i<2; i++){
      paths[i+35] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+320,280);
	 }
	 for (var i=0; i<3; i++){
      paths[i+37] = new component(40,40,eval("c.s"+((i+1)%2+1)),320,40*i+280);
	 }
	 for (var i=0; i<4; i++){
      paths[i+40] = new component(40,40,eval("c.s"+((i+1)%2+1)),i*40+160,360);
	 }
	 for (var i=0; i<3; i++){
      paths[i+44] = new component(40,40,eval("c.s"+(i%2+1)),i*40+80,400);
	 }
	 for (var i=0; i<3; i++){
      paths[i+47] = new component(40,40,eval("c.s"+((i+1)%2+1)),80,40*i+280);
	 }
	 // Interior
	 for (var i=0; i<2; i++){
      paths[i+50] = new component(40,40,eval("c.s"+(i%2+1)),160,40*i+160);
	 }
	 for (var i=0; i<2; i++){
      paths[i+52] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+200,160);
	 }
	 for (var i=0; i<3; i++){
	  for (var j=0; j<2; j++) {
      paths[i+j*3+54] = new component(40,40,eval("c.s"+((i+j+2)%2+1)),40*i+240,(j-1)*40+120);
	  }
	 }
	 for (var i=0; i<2; i++){
      paths[i+60] = new component(40,40,eval("c.s"+(i%2+1)),320,40*i+160);
	 }
      paths[62] = new component(40,40,eval("c.t1"),200,40*i+200);
      paths[63] = new component(40,40,eval("c.s2"),240,200);
	  paths[101] = new component(40,40,eval("c.s1"),200,200);
	  paths[102] = new component(40,40,eval("c.s2"),200,240);
	 for (var i=0; i<4; i++){
      paths[i+64] = new component(40,40,eval("c.s"+(i%2+1)),120+(i*40),280);
	 }
	 // Green part.
	 for (var i=0; i<5; i++) {
	 paths[i+68] = new component(40,40,eval("c.g"+((i+1)%2+1)),40,40*i+40);
	 }
	 for (var i=0; i<6; i++) {
	 paths[i+73] = new component(40,40,eval("c.g"+((i+1)%2+1)),360,40*i+40);
	 }
	 for (var i=0; i<5; i++) {
	 paths[i+79] = new component(40,40,eval("c.g"+(i%2+1)),280,40*i+160);
	 }
	 for (var i=0; i<4; i+=2) { // twice
	 paths[i/2+84] = new component(40,40,eval("c.g2"),40*i+120,(-40)*i+200);
	 }
	 for (var i=0; i<4; i+=2) { // twice
	 paths[i/2+86] = new component(40,40,eval("c.g1"),40*i+80,(-40)*i+200);
	 }
	 for (var i=0; i<3; i+=2) { // once
	 paths[i/2+88] = new component(40,40,eval("c.g2"),40*i+120,(-40)*i+120);
	 }
	 for (var i=0; i<3; i+=2) { // once
	 paths[i/2+90] = new component(40,40,eval("c.g1"),40*i+120,(-40)*i+160);
	 }
	 for (var i=0; i<3; i++) {
	 paths[i+92] = new component(40,40,eval("c.g"+(i%2+1)),40*i+240,40);
	 }
	 for (var i=0; i<4; i++) {
	 paths[i+95] = new component(40,40,eval("c.g"+(i%2+1)),40*i+120,320);
	 }
	 paths[99] = new component(40,40,eval("c.b2"),120,360);
	 paths[100] = new component(40,40,eval("c.g2"),320,240);
	 paths[103] = new component(40,40,eval("c.g2"),240,240);
	 break;
   case "6":
     dir = [0,1];
	 Blockly.goal("You now have while path blocks! Use one with three blocks in it to complete the level!",function(){
	    Blockly.how('While path blocks: Executes the script inside until a path doesn\'t exist.')},4);
	 var player = new component(40, 40, "red",40, 400);
	 var directionplayer = new component(10,10,"#ff8888",40,40)
	 for (var i=0; i<11; i++){
      paths[i] = new component(40,40,eval("c.s"+(i%2+1)),0,40*i);
	 }
	 for (var i=0; i<11; i++){
      paths[i+11] = new component(40,40,eval("c.s"+(i%2+1)),400,40*i);
	 }
	 for (var i=0; i<9; i++){
      paths[i+22] = new component(40,40,eval("c.s"+(i%2+1)),80,40*i+80);
	 }
	 for (var i=0; i<6; i++){
      paths[i+31] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+120,80);
	 }
	 for (var i=0; i<9; i++){
      paths[i+37] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+40,0);
	 }
	 for (var i=0; i<6; i++){
      paths[i+46] = new component(40,40,eval("c.s"+(i%2+1)),40*i+160,160);
	 }
	 for (var i=0; i<6; i++){
      paths[i+52] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+120,320);
	 }
	 for (var i=0; i<6; i++){
      paths[i+58] = new component(40,40,eval("c.s"+(i%2+1)),40*i+160,400);
	 }
	 for (var i=0; i<2; i++){
      paths[i+64] = new component(40,40,eval("c.s"+(i%2+1)),200,40*i+200);
	 }
	 for (var i=0; i<2; i++){
      paths[i+66] = new component(40,40,eval("c.s"+((i+1)%2+1)),280,40*i+240);
	 }
	 paths[68] = new component(40,40,eval("c.s1"),160,240);
	 paths[69] = new component(40,40,eval("c.s1"),320,240);
	 // Green part.
	 for (var i=0; i<10; i++){
      paths[i+70] = new component(40,40,eval("c.g"+((i+1)%2+1)),40,40*i+40);
	 }
	 for (var i=0; i<8; i++){
      paths[i+80] = new component(40,40,eval("c.g"+(i%2+1)),40*i+80,40);
	 }
	 for (var i=0; i<7; i++){
      paths[i+88] = new component(40,40,eval("c.g"+((i+1)%2+1)),40*i+120,360);
	 }
	 for (var i=0; i<7; i++){
      paths[i+95] = new component(40,40,eval("c.g"+((i+1)%2+1)),40*i+120,120);
	 }
	 for (var i=0; i<4; i++){
      paths[i+102] = new component(40,40,eval("c.g"+((i+1)%2+1)),40*i+120,280);
	 }
	 for (var i=0; i<4; i++){
      paths[i+106] = new component(40,40,eval("c.g"+(i%2+1)),40*i+240,200);
	 }
	 for (var i=0; i<2; i++){
      paths[i+110] = new component(40,40,eval("c.g"+(i%2+1)),360-120*i,160*i+80);
	 }
	 for (var i=0; i<3; i++){
      paths[i+112] = new component(40,40,eval("c.g"+(i%2+1)),120,40*i+160);
	 }
	 for (var i=0; i<3; i++){
      paths[i+115] = new component(40,40,eval("c.g"+(i%2+1)),360,40*i+240);
	 }
	 paths[118] = new component(40,40,eval("c.g1"),160,200);
	 paths[119] = new component(40,40,eval("c.g1"),320,280);
	 paths[120] = new component(40,40,eval("c.b1"),120,400);
	 break;
   case "7":
     var dir = [0,1];
   	 var player = new component(40, 40, "red",360, 360);
	 var directionplayer = new component(10,10,"#ff8888",40,40)
	 Blockly.goal("You now have repeat until path blocks! Use one with 3 blocks in it to complete the level!",function(){
	 Blockly.how('While path blocks: Executes the script inside until a path doesn\'t exist. Hint 1: Put a move forward before the repeat until block. Hint 2: Use the \'to the left\' option.')},4);
	 for (var i=0; i<3; i++){
      paths[i] = new component(40,40,eval("c.s"+((i+1)%2+1)),320,40*i+280);
	 }
	 for (var i=0; i<3; i++){
      paths[i+3] = new component(40,40,eval("c.s"+(i%2+1)),280,40*i+280);
	 }
	 for (var i=0; i<7; i++){
      paths[i+6] = new component(40,40,eval("c.s"+(i%2+1)),200,40*i+120);
	 }
	 for (var i=0; i<4; i++){
      paths[i+13] = new component(40,40,eval("c.s"+(i%2+1)),40*i+280,200);
	 }
	 for (var i=0; i<8; i++){
	  if (i+17 != 23) {
        paths[i+17] = new component(40,40,eval("c.s"+(i%2+1)),400,40*i+80);
	  } else {
        paths[23] = new component(40,40,c.g2,400,320);
	  }
	 }
	 for (var i=0; i<3; i++){
      paths[i+25] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i+240,120);
	 }
	 for (var i=0; i<11; i++){
      paths[i+28] = new component(40,40,eval("c.s"+((i+1)%2+1)),40*i,40);
	 }
	 for (var i=0; i<7; i++){
      paths[i+39] = new component(40,40,eval("c.s"+((i+1)%2+1)),120,40*i+80);
	 }
	 for (var i=0; i<11; i++){
      paths[i+46] = new component(40,40,eval("c.s"+(i%2+1)),40*i,400);
	 }
	 for (var i=0; i<3; i++){
      paths[i+57] = new component(40,40,eval("c.s"+(i%2+1)),80,40*i+240);
	 }
	 for (var i=0; i<8; i++){
      paths[i+60] = new component(40,40,eval("c.s"+(i%2+1)),0,40*i+80);
	 }
	 for (var i=0; i<4; i++){
      paths[i+68] = new component(40,40,eval("c.s"+(i%2+1)),40,40*i+40);
	  // paths[69] = new component(40,40,eval("c.s2"),40,80);
	 }
	 // finish.
      paths[72] = new component(40,40,eval("c.b2"),80,80);
	 // Green part.
	 for (var i=0; i<4; i++) {
       paths[i+73] = new component(40,40,eval("c.g"+((i+1)%2+1)),80,40*i+80);
	 }
	 for (var i=0; i<8; i++) {
  	   paths[i+77] = new component(40,40,eval("c.g"+((i+1)%2+1)),160,40*i+80);
	 }
	 for (var i=0; i<6; i++) {
  	   paths[i+85] = new component(40,40,eval("c.g"+((i+1)%2+1)),240,40*i+160);
	 }
	 for (var i=0; i<5; i++) {
  	   paths[i+91] = new component(40,40,eval("c.g"+((i+1)%2+1)),40,40*i+200);
	 }
	 for (var i=0; i<4; i++) {
  	   paths[i+96] = new component(40,40,eval("c.g"+(i%2+1)),360,40*i+240);
	 }
	 for (var i=0; i<3; i++) {
  	   paths[i+100] = new component(40,40,eval("c.g"+(i%2+1)),360,40*i+80);
	 }
	 for (var i=0; i<2; i++) {
  	   paths[i+103] = new component(40,40,eval("c.g"+(i%2+1)),40*i+80,360);
	 }
	 for (var i=0; i<4; i++) {
  	   paths[i+105] = new component(40,40,eval("c.g"+(i%2+1)),40*i+200,80);
	 }
	 for (var i=0; i<2; i++) {
  	   paths[i+109] = new component(40,40,eval("c.g"+(i%2+1)),40*i+280,160);
	 }
	 for (var i=0; i<2; i++) {
  	   paths[i+111] = new component(40,40,eval("c.g"+(i%2+1)),40*i+280,240);
	 }
	 paths[113] = new component(40,40,eval("c.b2"),80,80);
	 paths[69] = new component(40,40,eval("c.g2"),40,80); // Replace 69 to a grass. Funny that it is 69.
	 paths[19] = new component(40,40,eval("c.g2"),400,160);
}	 
console.warn("Took "+((new Date())-load)+"ms to load the game!")
/// Funny how level 1 has a simpler level than level 2, which has a simpler level than level 3, and so on... until level 5 being the most complex :P

//       paths[i+14] = new component(40,40,eval("c.s"+(i%2+1)),40,40*i);
//            ------                            -----        -------
///          blocknum                           colour   pos   (x)  (y)
var clear = function() {
    canvas.clearRect(0, 0, 1000,1000);
}
var paths_danger = [];
var paths_ = {};
var d = []
paths_.update = function(){
for (var i=0; i<paths.length; i++) {
    try {
      paths[i].update();
	  if (paths[i].c == c.s1 || paths[i].c == c.s2) paths_danger.push([paths[i].x,paths[i].y]);
	} catch(e){
	  if (d.indexOf(i) != -1) {
	   console.warn("Error trying to update (one-index-based) #"+(i+1)+"! Try to fix it!");
	   d.push(i);
	  }
	}
  }
}
paths_.update();
function updateGameArea() {
  clear();
  paths_.update();
  player.update();
  if (dir[0] === 1 && dir[1] === 0) {
       directionplayer.x = player.x + 27;
       directionplayer.y = player.y + 14;
  } else if (dir[0] === -1 && dir[1] === 0) {
	   directionplayer.x = player.x + 2;
       directionplayer.y = player.y + 14;
  } else if (dir[0] === 0 && dir[1] === 1) {
	   directionplayer.x = player.x + 14;
       directionplayer.y = player.y + 2;
  } else if (dir[0] === 0 && dir[1] === -1) {
	   directionplayer.x = player.x + 14;
	   directionplayer.y = player.y + 27;
  }
  directionplayer.update();
}
canvas.interval = setInterval(updateGameArea, 20);
function restartlevel(){
     switch(levelno){
	    case "1":
		   player.x = 40;
		   player.y = 40;
	 }
}
Blockly.JavaScript["move_forward"] = function(block){
    return "move('forward');\n";
}
Blockly.JavaScript["move"] = function(block){
    return "move('" + block.getFieldValue('way') + "');\n";
}
Blockly.JavaScript['run'] = function(block) {
  var code = Blockly.JavaScript.statementToCode(block, 'run');
  // TODO: Assemble JavaScript into code variable.
  return code;
};
Blockly.JavaScript['move_rotate'] = function(block) {
  var a = block.getFieldValue('direction');
  // TODO: Assemble JavaScript into code variable.
  var code = "turn(90,'"+a+"');\n";
  return code;
};
Blockly.JavaScript['controls_repeat_limited'] = function(block){
  var n = block.getFieldValue('count');
  var s = Blockly.JavaScript.statementToCode(block, 'command');
  var va = Blockly.JavaScript.variableDB_.getDistinctName(
    'count', Blockly.Variables.NAME_TYPE);
  return 'for (var '+va+' = 0; '+va+' < '+n+'; '+va+'++) {\n'+s+'}\n';
}
Blockly.JavaScript['controls_repeat_limited2'] = function(block){
  var n = block.getFieldValue('count');
  var s = Blockly.JavaScript.statementToCode(block, 'command');
  var va = Blockly.JavaScript.variableDB_.getDistinctName(
    'count', Blockly.Variables.NAME_TYPE);
  return 'for (var '+va+' = 0; '+va+' < '+n+'; '+va+'++) {\n'+s+'}\n';
} // Clone... but with a limit of 20 instead of 10!
Blockly.JavaScript['logic_has_space'] = function(block) {
  var a = block.getFieldValue('NAME');
  var b = Blockly.JavaScript.statementToCode(block, 'script');
  // TODO: Assemble JavaScript into code variable.
  var code = "if (isThere('"+a+"')) {\n"+b+"}\n";
  return code;
};

Blockly.JavaScript['logic_has_space_with_else'] = function(block) {
  var a = block.getFieldValue('NAME');
  var b = Blockly.JavaScript.statementToCode(block, 'script');
  var c = Blockly.JavaScript.statementToCode(block, 'script2');
  // TODO: Assemble JavaScript into code variable.
  var code = "if (isThere('"+a+"')) {\n"+b+"} else {\n"+c+"}\n";
  return code;
};

Blockly.JavaScript['loops_until_finish'] = function(block){
  var statements_script = Blockly.JavaScript.statementToCode(block, 'script');
  var code = 'while (!touchingFinish()) {\n'+statements_script+'}\n'
  return code;
};

Blockly.JavaScript['loops_while_space'] = function(block) {
  var a = block.getFieldValue('value');
  var b = Blockly.JavaScript.statementToCode(block, 'script');
  // TODO: Assemble JavaScript into code variable.
  var code = "while (isThere('"+a+"')) {\n"+b+"}\n";
  return code;
}

Blockly.JavaScript['loops_until_space'] = function(block) {
  var a = block.getFieldValue('value');
  var b = Blockly.JavaScript.statementToCode(block, 'script');
  // TODO: Assemble JavaScript into code variable.
  var code = "while (!(isThere('"+a+"'))) {\n"+b+"}\n";
  return code;
}

function move_(a) {
    switch(a){
	   case "forward":
	      player.x += 40*dir[0];
		  player.y += -40*dir[1];
		  return;
	   case "backward":
	      player.x += -40*dir[0]
		  player.y += 40*dir[1]
		  return;
	}
	throw "Unknown path way '"+a+"'."
}
var turn__ = function(a,b){
    switch(a){
	   case 90:
	      var radians = Math.atan2(dir[1],dir[0]);
		  var degrees = radians * (180/Math.PI);
		  if (b == 'right') {
		    turn__(90,'left');
			turn__(90,'left');
			turn__(90,'left');
		    return;
		  }
		  degrees += 90;
		  radians = degrees * (Math.PI/180);
		  dir = [Math.round(Math.cos(radians)),Math.round(Math.sin(radians))];
		  break;
	   case 180:
	      turn(90,'left');
		  turn(90,'left');
	}
};
var touchingFinish__ = function(){
    var blueblock = [];
	for (var i=0; i<paths.length; i++){
	  if (paths[i].c == c.b1 || paths[i].c == c.b2){
	    blueblock.push(paths[i]);
	  }
	};
	if (blueblock.length < 1) throw new Error("Cannot find the finish.");
	blueblock = blueblock[0];
	return (player.x == blueblock.x) && (player.y == blueblock.y);
}
workspace.addChangeListener(Blockly.Events.disableOrphans);
function initApi(interpreter, globalObject) {
  // Add an API function for the move('forward / backward') block.
  var wrapper = function(a){return move_(arguments.length ? a : 'forward')};
  interpreter.setProperty(globalObject, 'move',
      interpreter.createNativeFunction(wrapper));
  wrapper = function(id) {
    return workspace.highlightBlock(id);
  };
  interpreter.setProperty(globalObject, 'highlightBlock',
      interpreter.createNativeFunction(wrapper));
  wrapper = function(a,b) {return turn__(((a != 90 && a != 180) ? 180 : a),b)};
  interpreter.setProperty(globalObject, 'turn',
      interpreter.createNativeFunction(wrapper));
  wrapper = function(){
    return __checkBlocks();
  }
  interpreter.setProperty(globalObject, '__checkBlocks',
      interpreter.createNativeFunction(wrapper));
  wrapper = function(a){
    return isThere(a);
  }
  interpreter.setProperty(globalObject, 'isThere',
      interpreter.createNativeFunction(wrapper));
  wrapper = function(){
    return touchingFinish__();
  }
  interpreter.setProperty(globalObject, 'touchingFinish',
      interpreter.createNativeFunction(wrapper));
}
function result(a){
    setTimeout(function(a){
	  workspace.highlightBlock('');
	  var level_XY = [[360,40],[400,360],[320,80],[280,280],[120,360],[120,400],[80,80]]; // Finish
	  var level_start_XY = [[40,40],[40,120],[40,80],[0,360],[40,40],[40,400],[360,360]]; // Start
	  var level_directions = [[1,0],[1,0],[1,0],[1,0],[0,-1],[0,1],[0,1]]; // Directions
	  
	  var level_XY_current = level_XY[Number(levelno)-1];
	  var level_start_XY_current = level_start_XY[Number(levelno)-1];
	  var level_directions_current = level_directions[Number(levelno)-1];
	  
	  
	  if (player.x == level_XY_current[0] && player.y == level_XY_current[1]){
	    Blockly.congrats("You finished level "+levelno+"! Continue to next level?",function(){window.location.href = "?level="+(Number(levelno)+1);});
		stepper = null;
	  } else if (a === 1) { // Means that player touched a black block.
	     Blockly.alert("The cube touched a black block and got teleported to the beginning.");
	  } else if (a === 2) { // Means that player is off the screen.
	     Blockly.alert("The player got outside the game board and got teleported to the beginning.");
	  } else if (a === 3) { // For stopping the code.
	     var a = document.getElementById("run");
		 var b = document.getElementById("stop");
	     a.disabled = false;
         b.disabled = true;
		 stepper = null;
		 console.log("Stopped the code!")
	  } else if (a === true) {
	     Blockly.alert("Keep trying! Something is not right.");
	  }
	  player.x = level_start_XY_current[0]; player.y = level_start_XY_current[1]; dir = level_directions_current;
	},1000,a);
}
</script>
   <p id="b">Blocks: 0/n</p>
   <button id="run">Run &#9654;</button><a style="color: white;">----</a><fonted><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEFSURBVEhL7ZbLCoQwDEV1fID4hYML0e9yI4L+ovicMAkdbJs2C7sZPAvNldvc0rpIfJ5nFJIXvYPxBHh5Arw8AV7+PuD9hYQA0+8KUFZtDYfVzwYImyo4vz1Ac0/TRBWDw28JuLE7oAfc2x24BNzeHfgFhOgOUECg7oDlktM0pUqG208BXddhAWzb1jQNCQa5/zcXzfPctq2SeZ73fY+1FaH/Mnit61rXtfqSJAmsgSdKE4n/cgdZlg3DEMcxyn3fYT10QWki8euXDPnjOKpdwBo4XzgNlCZePzubwl6WZSEh+HE5v+U3ReA0i6LAuixLLBxwfs90XVXVcRze7StMf+DxPYo+7/mwz0HhFmMAAAAASUVORK5CYII="></img></fonted><input type="range" min="5" max="100" id="speed"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEHSURBVEhL7ZXbDkQwEIbbOoR4QXsh4r1EIoKn8h7iEDt2ZrvUbkS7vfNd1Iz+k19nCL4sC7OJoKs1boNTboNTboNTboNTVoPHC8y/YiLgcRxTyFjbthRt2FZqCHYt+vUUEg2BUDyPCkPBegKrHtQiex6fGVjyUH/6SplSA1wV7N4i4O/nUA0A13Up+sElgWqQZdk0TZQwluc5RW+uCnYzSNN0GAaMOedFUQRBgCmiISCDeZ5hD1a5V5al53mYAtqCtUXjOCp7VVVti00Eou976JrccxynaRpYMQUMBU7XdXIMvu+DM8aSJElMBCKKIozCMISuYbzFULAOGT4WIURd13TvgL6AsSfrf+qiFuuxiAAAAABJRU5ErkJggg=="></img><a style="color: white;">----</a><button id="stop">Stop 🛑 (buggy)</button><p></p><button id="seecode">See Code <code>&lt;/&gt;</code></button><a style="color: white;">----</a><button id="levelselect" onclick="window.location.href = 'level.html?level='+levelno;">Level Select</button><button id="help" style="float: right;">Help</button>
   <script>
   document.getElementById("run").addEventListener("click",function(){
  Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
  console.log("Execute: \n"+Blockly.JavaScript.workspaceToCode(workspace));
  var stepper = new Interpreter(Blockly.JavaScript.workspaceToCode(workspace),initApi);
  var nextStep = function(a) {
    if (a !== true) a = false;
	if (a) {
	document.getElementById("run").disabled = true;
	document.getElementById("stop").disabled = false;
	}
    var isg = true;
    for (var i=0; i<paths_danger.length; i++){
	   if (player.x == paths_danger[i][0] && player.y == paths_danger[i][1]) isg = 1;
	}
	if (player.y > 400 || player.y < 0 || player.x < 0 || player.x > 440) isg = 2;
    if (stepper.step() && (isg === true)) {
      setTimeout(nextStep, 105 - document.getElementById('speed').value);
    } else {
	  document.getElementById("run").disabled = false;
      document.getElementById("stop").disabled = true;
	  result(isg);
	}
  }
  nextStep(true);
});
/**
    Function: __checkBlocks
    Args: none
	What it does: Takes the 4 nearest blocks (-x, -y, +x, +y), and returns them in {
	   -x
	   -y
	   +x
	   +y
	}
	For each item it returns: {
	  true - It is a grass block.
	  false - It is a black block.
	  null - No block in the position.
	  '$CUSTOM' - Custom block?
	  'NOT' - Not recongized.
	}
*/
var __checkBlocks = function(){
   var x = player.x;
   var y = player.y;
   var blocks = {};
   var isGreen = function(a){
     if (a.c == c.s1 || a.c == c.s2) return false;
	 if (a.c == c.g1 || a.c == c.g2) return true;
	 return 'NOT';
   }
   for (var i = 0; i < paths.length; i++) {
      var bx = paths[i].x
	  var by = paths[i].y;
	  var difx = Math.abs(x - bx);
	  var _difx = x - bx;
	  difx /= 40;
	  var _dify = y - by;
	  var dify = Math.abs(y - by);
	  dify /= 40;
      if ((difx == 1 && dify == 0) || (difx == 0 && dify == 1)) {
	     var part = (difx == 1) ? (_difx == 40 ? ("-x") : ("+x")) : (_dify == 40 ? ("+y") : ("-y")) // ( IF X [IF NEG,POS]) ( IF Y [IF POS,NEG])
	     blocks[part] = isGreen(paths[i]);
	  }
   }
   if (typeof blocks["-x"] === "undefined") blocks["-x"] = null;
   if (typeof blocks["-y"] === "undefined") blocks["-y"] = null;
   if (typeof blocks["+x"] === "undefined") blocks["+x"] = null;
   if (typeof blocks["+y"] === "undefined") blocks["+y"] = null;
   return blocks;
}
  document.getElementById("seecode").addEventListener("click",function(){
       Blockly.JavaScript.STATEMENT_PREFIX = '';
	   Blockly.JavaScript.INFINITE_LOOP_TRAP = '';
	   var code = Blockly.JavaScript.workspaceToCode(workspace);
	   Blockly.code(code);
  });
 
var elem = document.getElementById("b");
setInterval(function(){
   elem.innerHTML = mes_maxblock;
   elem.style.color = mes_maxblocks_color;
},50)

/**
  Function: isThere
  Args: dir - left, right, ahead
  What it does: Check if there is space in a path
  Dependencies: __checkBlocks [function]
*/
var isThere = function(dir_){
  switch(dir_){
    case "ahead":
	   var degrees = Math.atan2(dir[0],dir[1]) * (180 / Math.PI)
	   var temp_d = "";
	   break;
	case "left":
	   var degrees = Math.atan2(dir[0],dir[1]) * (180 / Math.PI) - 90;
	   if (degrees == -180) degrees = 180;
	   var temp_d = "";
	   break;
	case "right":
	   var degrees = Math.atan2(dir[0],dir[1]) * (180 / Math.PI) + 90;
	   if (degrees == 270) degrees = -90;
	   var temp_d = "";
	   break;
  }
  console.log(degrees);
  switch(degrees){
         case -360:
		   temp_d = "+y"
		   break;
         case 360:
		   temp_d = "+y"
		   break;
         case 90:
		   temp_d = "+x"
		   break;
	     case -270:
		   temp_d = "+x"
		   break;
		 case 0:
		   temp_d = "+y"
		   break;
		 case -90:
		   temp_d = "-x";
		   break;
		 case 270:
		   temp_d = "-x";
		   break;
		 case -180:
		   temp_d = "-y";
           break;		   
		 case 180:
		   temp_d = "-y";
		   break;
  }
  var blocks = __checkBlocks();
  var b__= blocks[temp_d];
  console.log(temp_d);
  return !!b__;
}
document.getElementById('stop').disabled = true;
document.getElementById('stop').addEventListener("click",function(){
     result(3);
});
</script>
   </body>
</html>